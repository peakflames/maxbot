# apply_code_patch Tool Specification

## Purpose
Apply code changes using Git-style unified diff patches. More robust than string replacement for handling whitespace and formatting variations. This is the preferred tool for precise modifications without rewriting entire files.

## Parameters
- `path` (required): The path of the file to modify (relative to the current working directory)
- `patch` (required): The unified diff patch to apply. Can be generated from generate_code_patch or created manually.
- `useFuzzyMatching` (optional): Whether to use fuzzy matching if exact patch application fails (default: true)

## Usage
```xml
<apply_code_patch>
<path>src/app.js</path>
<patch>--- a/src/app.js
+++ b/src/app.js
@@ -1,3 +1,4 @@
 import React from 'react';
+import { useState } from 'react';
 
 function App() {
</patch>
<useFuzzyMatching>true</useFuzzyMatching>
</apply_code_patch>
```

## Capabilities
- Applies Git-style unified diff patches to files
- Supports multiple hunks in a single patch
- Fuzzy matching for handling minor formatting differences
- Atomic operations with file integrity verification
- Automatic backup creation before modification
- SHA256 checksum validation after changes

## Unified Diff Format
The tool accepts standard unified diff format:
```
--- a/filename
+++ b/filename
@@ -start,count +start,count @@
 context line
-removed line
+added line
 context line
```

## Best Practices
- Default choice for most file modifications
- More robust than SEARCH/REPLACE blocks for handling whitespace variations
- Use `generate_code_patch` to create patches programmatically
- Enable fuzzy matching for resilience against minor formatting differences
- Preview changes with `preview_patch_application` before applying

## When to Use
- Making targeted code changes
- Applying patches generated by version control systems
- Modifying files with consistent formatting requirements
- When exact line matching is important
- Updating configuration files with structured changes

## When NOT to Use
- Creating new files (use `write_to_file`)
- Complete file restructuring
- When majority of file content needs to change

## Fuzzy Matching
When enabled, fuzzy matching can handle:
- Minor whitespace differences
- Line offset variations
- Small formatting inconsistencies

Fuzzy matching strategies include:
- **Line Offset Strategy**: Adjusts for line number shifts
- **Whitespace Normalization**: Handles spacing variations

## Error Handling
- Returns error if file doesn't exist
- Returns error if patch format is invalid
- Returns error if patch cannot be applied (even with fuzzy matching)
- Returns error if path is outside working directory
- Respects read-only file permissions

## Security Features
- Working directory constraint enforcement
- Path traversal attack prevention
- Read-only file attribute respect
- Approval required for destructive operations (configurable)

## Output Format
Success response includes:
- Applied patch summary (lines added/removed, hunks applied)
- File integrity information (SHA256 checksums)
- Final file content for verification
- Fuzzy matching details if used

## Integration with Other Tools
- Often preceded by `read_file` to understand current content
- Can use patches from `generate_code_patch`
- May be previewed with `preview_patch_application`
- Commonly combined with `search_files` to find modification targets

## Advanced Examples

### Multiple Hunks
```xml
<apply_code_patch>
<path>src/config.js</path>
<patch>--- a/src/config.js
+++ b/src/config.js
@@ -1,2 +1,2 @@
-const API_URL = 'http://localhost:3000';
+const API_URL = 'https://api.production.com';
 const DEBUG = false;
@@ -10,3 +10,4 @@
 module.exports = {
   API_URL,
   DEBUG,
+  VERSION: '1.0.0'
 };
</patch>
</apply_code_patch>
```

### Adding New Functions
```xml
<apply_code_patch>
<path>src/utils.js</path>
<patch>--- a/src/utils.js
+++ b/src/utils.js
@@ -5,3 +5,8 @@
 function existingFunction() {
   return 'existing';
 }
+
+function newFunction() {
+  return 'new functionality';
+}
+
</patch>
</apply_code_patch>
```

### Removing Code
```xml
<apply_code_patch>
<path>src/deprecated.js</path>
<patch>--- a/src/deprecated.js
+++ b/src/deprecated.js
@@ -1,8 +1,3 @@
 function keepThis() {
   return 'keep';
 }
-
-function removeThis() {
-  return 'deprecated';
-}
-
</patch>
</apply_code_patch>
```

## Common Patterns

### Import Additions
```xml
<apply_code_patch>
<path>src/component.jsx</path>
<patch>--- a/src/component.jsx
+++ b/src/component.jsx
@@ -1,2 +1,3 @@
 import React from 'react';
+import PropTypes from 'prop-types';
 
</patch>
</apply_code_patch>
```

### Configuration Updates
```xml
<apply_code_patch>
<path>package.json</path>
<patch>--- a/package.json
+++ b/package.json
@@ -5,6 +5,7 @@
   "scripts": {
     "start": "node server.js",
     "test": "jest",
+    "build": "webpack --mode production",
     "dev": "nodemon server.js"
   },
</patch>
</apply_code_patch>
```

## Verification Methods
- **Test**: Automated tests verify patch application accuracy
- **Analysis**: Static analysis of patch format and content
- **Demonstration**: Live demonstration of patch application
- **Inspection**: Manual review of applied changes

## Related Tools
- `generate_code_patch` - Create patches for this tool
- `preview_patch_application` - Preview changes before applying
- `read_file` - Examine files before modification
- `write_to_file` - Alternative for complete file replacement
